# @ai-generated: true
# @ai-tool: Copilot
name: Run Unit Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  node_tests:
    name: Node.js tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies (root and UI, if present)
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            echo "Installing root Node deps...";
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
          fi
          if [ -f rdm-review-dashboard-ui/package.json ]; then
            echo "Installing UI deps...";
            cd rdm-review-dashboard-ui
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
          fi
      - name: Run npm test (root/UI if defined)
        shell: bash
        run: |
          set -e
          ran_any=0
          if [ -f package.json ]; then
            if node -e "const p=require('./package.json');process.exit(p.scripts&&p.scripts.test?0:1)"; then
              echo "Running root npm test...";
              npm test --silent || (echo "::error::npm test failed"; exit 1)
              ran_any=1
            else
              echo "No test script in root package.json; skipping";
            fi
          fi
          if [ -f rdm-review-dashboard-ui/package.json ]; then
            pushd rdm-review-dashboard-ui >/dev/null
            if node -e "const p=require('./package.json');process.exit(p.scripts&&p.scripts.test?0:1)"; then
              echo "Preparing to run UI npm test...";
              # Skip if there are no spec files
              if ! find src -type f -name "*.spec.ts" | grep -q .; then
                echo "No UI spec files found; skipping UI tests";
              elif command -v google-chrome >/dev/null 2>&1 || command -v chromium >/dev/null 2>&1 || command -v chromium-browser >/dev/null 2>&1; then
                echo "Running UI npm test with ChromeHeadless...";
                LOG=$(mktemp)
                set +e
                npm test --silent -- --watch=false --browsers=ChromeHeadless | tee "$LOG"
                UI_RC=${PIPESTATUS[0]}
                set -e
                if [ "$UI_RC" -ne 0 ]; then
                  if grep -q "Executed 0 of 0 SUCCESS" "$LOG"; then
                    echo "UI suite empty; treating as success";
                  else
                    echo "::error::UI npm test failed"; exit 1;
                  fi
                fi
                ran_any=1
              else
                echo "Chrome/Chromium not available on runner; skipping UI tests";
              fi
            else
              echo "No test script in UI; skipping";
            fi
            popd >/dev/null
          fi
          if [ "$ran_any" -eq 0 ]; then
            echo "No Node tests found; skipping";
          fi

  python_tests:
    name: Python tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install backend dependencies (if present)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f rdm-review-dashboard-backend/requirements.txt ]; then
            pip install -r rdm-review-dashboard-backend/requirements.txt || true
          fi
          if [ -f rdm-review-dashboard-backend/requirements-dev.txt ]; then
            pip install -r rdm-review-dashboard-backend/requirements-dev.txt || true
          else
            pip install pytest || true
          fi
      - name: Run pytest (backend if tests exist)
        shell: bash
        run: |
          if find rdm-review-dashboard-backend/tests -type f -name '*.py' 2>/dev/null | grep -q .; then
            echo "Running backend pytest...";
            (cd rdm-review-dashboard-backend && pytest -q) || (echo "::error::pytest failed"; exit 1)
          else
            echo "No backend Python tests found; skipping"
          fi
